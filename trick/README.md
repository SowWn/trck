# `Trick` - Model-based testing for `trck` machines

Trick is a simple [model-based testing](https://en.wikipedia.org/wiki/Model-based_testing) framework for `trck` machines that find matching patterns in sequences of events or trails.

Testing `trck` machines with unit tests is possible but designing suitable test sequences manually is tedious and error-prone. Trick solves this problem by generating event sequences automatically based on simple test case specifications. Trick can produce all combinations of various events and fields automatically, which is an effective way to surface bugs and corner cases which would not have been found by unit tests that focus on typical cases.

Whereas a single `trck` machine can handle multiple related patters of events, which often leads to somewhat convoluted `.tr` specifications, Trick encourages decoupling of different cases in separate tests. Trick cases are designed to be as human-readable as possible, sacrificing perfect test coverage to understandability.

An important feature of Trick is that it is fully deterministic. Test cases are produced by combinatorial search, instead of random sampling. Trick's results are always reproducible.

## Usage

```
python trick.py my-metric.tr my-metric-tests.trick
```

## Syntax

Trick files have a straightforward, line-oriented structure. Each line is a syntactic unit in Trick.

```
# Test Case 1
Parameters 1
Event Sequence 1
...

# Test Case 2
...
```

Each file consists of multiple **test cases** that start with a header line, a hash mark followed by a title.

The lines following the header line are **parameters**, as listed below. Parameters map closely to corresponding structures in `trck`.

#### Time-Window

`Window: 30 days`

Specifies the maximum time window for the event sequence. Translates to `window` in `trck` files. Allowed time units are `days`, `hours`, `minutes`, and `seconds`.

#### Input

`Input: @adgroups_campaign = %ag_id, %camp_id`

Defines a set of input arguments for the `trck` machine. This corresponds to the top-level `foreach` structure in `trck`, such as

```foreach %ag_id, %camp_id in @adgroups_campaign```

#### Output

`Output: $engaged = 1, $new = 1`

Defines the expected output for this test case as a comma-separated list.

#### Params

`Params: #conversion_segments, %tonight = 0`

Defines parameters of the `trck` machine as a comma-separated list. Parameters can be either scalar values, denoted by the `%` sigil or sets, denoted by `#`. It is possible to leave values of a set undefined, in which case the set is populated automatically.

#### Alternative Parameters

```
-Params: #conversion_segments, %tonight = 10000000
-Output: $engaged = 0
```

Specifies an alternative set of parameters and outputs, prefix with a dash (`-`).

In some cases it is conveninent to define an alternative set of parameters and expected outputs for the same sequence of events. This can be used e.g. to verify that an incorrect time cursor (`%tonight` above) does not produce any results. This will in effect produce an additional test case with less boilerplate.

#### Positive Only

`Positive Only`

Specifies that Trick should only generate positive sequences for this test case.

By default, Trick automatically generates both negative and positive sequences based on the given constraints. With the `Positive Only` specification, only positive cases are generated. For more details, see below.

### Constraints

Constraints are the core of Trick. They specify a pattern of events that should produce the desired set of outputs. Note that often many different patterns of events can produce the same set of outputs. Trick encourages handling each pattern separately, each as a separate test case.

#### Event Constraints

One **event constraint** maps to exactly one positive event, i.e. an event that satisfies the given constraint, and to a variable number of preceding negative events that do not satisfy the constraint. The result is a sequence of events that produces a match, given a suitable `trck` machine. 

Syntax:

`[ type=pxl, campaign_id=%camp_id, segment_id in #conversion_segments ]`

An event constraint is enclosed in square brackets. Inside an event, multiple **fields** can be specified, separate with commas.

A **field** can either have a fixed (bound) value, like `type=pxl` above. This means that a positive event must have a field `type` with the value `pxl`. Fields can also refer to inputs, such as `%camp_id` above, or to sets, as `segment_id` above.

##### Must-Change Fields

`[ !type=pxl, !campaign_id=%camp_id, segment_id in #conversion_segments ]`

By default, negative events are generated by ensuring that exactly one of the fields does not satisfy the constraint, e.g. by setting `type=imp` above.

In some cases, it is necessary to ensure that multiple fields are negated to create a negative event. This can be accomplished by prefixing desired fields with an exclamation mark (`!`) which informs Trick that to negate this constraint, one of these fields must be negated, possibly in addition to another field.

#### Time Constraints

In addition to event constraints, Trick patterns can set constraints on time between events:

`< min 1 second, max 3 days >`

A **time-constraint** is enclosed to less-than and greater-than characters. It may specify the minimum and/or maximum length of time between surrounding events. Time is specified as with `Window` parameter above.

As an example, consider this real test case that defines an engaged user:

```
[ type=imp, campaign_id=%camp_id, adgroup_id=%ag_id ]
< max 3 days >
[ type=pxl, campaign_id=%camp_id, segment_id in #conversion_segments ]
```

An engaged user is someone who sees an impression of the desired `adgroup_id`, followed by a `pxl` event in one of the `conversion_segments` at most 3 days after the impression.

## Semantics

In the following, we define how actual test sequences are generated based on the test specifications.

#### Inputs and Trails

There is a 1:1 mapping between trails and inputs, i.e. one set of input values produce exactly one trail of events. This makes it easy to troubleshoot trails that do not produce the specified results.

#### Time

Each trail starts with a timestamp zero. Positive sequences respect the total time window, specified by the `Window` parameter, as long no conflictig time constraints have been specified.

### Positive Cases

Each constraint defines a possibly infinite set of possible field assignments and time windows which satisfy the constraint: Each event constraint may take any value from the sets specified. Each time constraint may generate any value in the given `min`-`max` range. To keep the set of positive assignments reasonably finite, the generated sets are kept small and time is discretized to large chunks.

Trick takes the set of positive assignments for each constraint and produces a cartesian product between all constraints to produce a set of positive sequences. Each positive sequence is given unqiue input arguments from an infinite list of inputs.

#### Filler Events

In addition to positive events, as defined above, each positive event is preceded by a number of negative events that act as a filler to simulate a realistic mixture of positive and negative events. These negative filler events are produced as described below.

### Negative Cases

By default, for every test case Trick produces a set of negative sequences that are expected to produce zero outputs. A negative sequence is a sequence that does not satisfy at least one of the given constraints.

It is important to note that Trick cannot guarantee that an automatically generated negative sequence does not produce any matches by the corresponding `trck` machine. In fact, it is typical that a single test case may be a superset of another test case and violating one of the constraints just transform this test case to another positive case. This false negatives can be kept in control by careful design of test cases and use of `Must-Change` fields and `Positive Only` specification, as defined above.

#### Negative Event

A negative event is an event that does not satisfy its event constraint. A negative event is produced by taking a positive event and altering one of the fields so that it does not satisfy the constraint.

If `Must-Change` fields are specified, one of the `Must-Change` fields is negated, if it had not been negated already by the above process.

#### Enumerated Fields

If a field has a only fixed assignments, like `type=pxl` and `type=imp` above, it is negated by altering its original assignments to one of the other valid assignments that occur in event constraints, i.e. `imp` becomes `pxl` and vice versa.

#### Free Fields

Input fields and set-fields are negated by attaching a prefix to the field value. This guarantees that the value can not satisfy the original constraint.

#### Negative Sequences

Negative sequences are generated using a two-level mechanism: First, we decide which event constraints need to be violated. Trick scans through all possible combinations constraint violations, i.e. if the test case contains *K* event constraints, there are *2^K - 1* possible ways to violate at least one of the constraints.

Secondly, the violated constraints are used to produce negative events as specified above. The non-violated constraints still produce positive events but as at least one of the event constraints is violated, the whole sequence must be a negative one.

Note that both violated and non-violated constraints produce negative filler events similar to positive sequences, as defined above.



